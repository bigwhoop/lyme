/*! LYME v1.2.3 (2013-05-19) | http://bigwhoop.github.io/lyme | MIT License */
$.fn.lyme=function(n){var e={markup:"",onMarkupChange:null,onPreInit:null,onPostInit:null,renderer:new $.fn.lyme.renderers.JSMarkdownExtra,plugins:[new $.fn.lyme.plugins.ScrollTo],hotKeys:$.fn.lyme.hotKeys},t=$.extend(e,n);if(t.markup instanceof $){var r=t.markup;t.plugins.push(new $.fn.lyme.plugins.TextareaAdapter(r))}t.plugins.forEach(function(n){$.isFunction(n.onGetMarkup)&&(t.markup=n.onGetMarkup())});var i={};if($.each(["onMarkupChange","onPreInit","onPostInit"],function(){$.isFunction(t[this])&&(i[this]=t[this])}),t.plugins.push(i),1==this.length)return new $.fn.lyme.Editor($(this),t);var o={};return this.each(function(){o[this.selector]=new $.fn.lyme.Editor($(this),t)}),o},$.fn.lyme.Editor=function(n,e){function t(){n.on("click",function(n){n.stopPropagation()}),$(document).on("click",function(){o.hideEditor()}),e.plugins.forEach(function(n){$.isFunction(n.setEditor)&&n.setEditor(o)}),r("onPreInit",[n,e]),o.setMarkup(e.markup),r("onPostInit",[o.getFullMarkup(),o.getFullHTML()])}function r(n,t){$.isArray(t)||(t=[]),e.plugins.forEach(function(e){$.isFunction(e[n])&&e[n].apply(null,t)})}function i(){return u++}var o=this;o.setRenderer=function(n){e.renderer=n},o.splitMarkup=function(n){return $.isFunction(e.renderer.split)?e.renderer.split(n):n.replace(/\r/g,"").replace(/\n\n\n/g,"\n\n").split("\n\n")};var u=0;o.createBlock=function(n,t){function u(n){var t=c.val(),i=s;return $.each(o.splitMarkup(t),function(n,t){var r=e.renderer.render(t);if(0==n)c.val(t),f.html(r);else{var u=o.createBlock(t,r);i.after(u.getElement()),i=u.getElement()}}),n!=t&&r("onMarkupChange",[o.getFullMarkup(),o.getFullHTML()]),t}t||(t=e.renderer.render(n));var a=i(),s=$('<div id="lyme-block-'+a+'" class="lyme-block">'),l=$('<div class="markup"></div>'),c=$("<textarea></textarea>"),f=$('<div class="preview"></div>');c.val(n),f.html(t),l.hide().append(c),s.append(l).append(f);var p=new $.fn.lyme.Block(s);return c.on("focusout",function(){r("onPreStopEditing",[p]),""==c.val()&&s.remove(),n=u(n),r("onPostStopEditing",[p])}),c.on("keydown",function(n){for(var t in e.hotKeys){var r=e.hotKeys[t];r.if(n)&&(n.preventDefault(),r.do(o,p))}}),f.on("click",function(){o.hideEditor(),r("onPreStartEditing",[p]),f.hide(),l.show(),c.focus(),r("onPostStartEditing",[p])}),p},o.getFullMarkup=function(){var e=[];return n.find(".lyme-block .markup textarea").each(function(){e.push($(this).val())}),e.join("\r\n\r\n")},o.getFullHTML=function(){return e.renderer.render(o.getFullMarkup())},o.setMarkup=function(e){n.empty(),$.each(o.splitMarkup(e),function(e,t){var r=o.createBlock(t);n.append(r.getElement())})},o.getElement=function(){return n},o.hideEditor=function(){n.find(".lyme-block .markup:visible textarea").blur(),n.find(".lyme-block .markup:visible").hide(),n.find(".lyme-block .preview").show()},t()},$.fn.lyme.Block=function(n){this.edit=function(){n.find(".preview").trigger("click")},this.getPreviousBlock=function(){var e=n.prev();return e.length?new $.fn.lyme.Block(e):!1},this.getNextBlock=function(){var e=n.next();return e.length?new $.fn.lyme.Block(e):!1},this.getMarkup=function(){return n.find("textarea").val()},this.setMarkup=function(e){n.find("textarea").val(e)},this.getElement=function(){return n}},$.fn.lyme.renderers={JSMarkdownExtra:function(){var n;this.render=function(e){return n||(n=new MarkdownExtra_Parser,n.init()),n.transform(e)},this.split=function(n){for(var e=n.replace(/\r/g,"").replace(/\n\n\n/g,"\n\n").split("\n\n"),t=[],r=[],i=0;e.length>i;i++)0==r.length?e[i].indexOf("~~~")>-1?r.push(e[i]):t.push(e[i]):(r.push(e[i]),e[i].indexOf("~~~")>-1&&(t.push(r.join("\n\n")),r=[]));return r.length&&t.push(r.join("\n\n")),t}},Showdown:function(){var n;this.render=function(e){return n||(n=new Showdown.converter),n.makeHtml(e)}}},$.fn.lyme.hotKeys={tabbing:{indentation:"    ","if":function(n){return 9==n.keyCode},"do":function(n,e){var t=e.getElement().find("textarea").get(0),r=t.selectionStart;t.value=t.value.substring(0,t.selectionStart)+this.indentation+t.value.substring(t.selectionEnd,t.value.length),setTimeout(function(){t.focus(),t.setSelectionRange(r+4,r+4)},0)}},escape:{"if":function(n){return 27==n.keyCode},"do":function(n){n.hideEditor()}},"place-before":{"if":function(n){return n.altKey&&n.ctrlKey&&n.shiftKey&&38==n.keyCode},"do":function(n,e){var t=e.getPreviousBlock();if(t){var r=e.getMarkup(),i=t.getMarkup();e.setMarkup(i),t.setMarkup(r),t.edit()}}},"place-after":{"if":function(n){return n.altKey&&n.ctrlKey&&n.shiftKey&&40==n.keyCode},"do":function(n,e){var t=e.getNextBlock();if(t){var r=e.getMarkup(),i=t.getMarkup();e.setMarkup(i),t.setMarkup(r),t.edit()}}},"move-up":{"if":function(n){return n.altKey&&n.ctrlKey&&38==n.keyCode},"do":function(n,e){var t=e.getPreviousBlock();t&&t.edit()}},"move-down":{"if":function(n){return n.altKey&&n.ctrlKey&&40==n.keyCode},"do":function(n,e){var t=e.getNextBlock();t&&t.edit()}},"append-empty-block":{"if":function(n){return n.altKey&&n.ctrlKey&&13==n.keyCode},"do":function(n,e){var t=n.createBlock("","");e.getElement().after(t.getElement()),t.edit()}},"remove-block":{"if":function(n){return n.altKey&&n.ctrlKey&&8==n.keyCode},"do":function(n,e){e.setMarkup("");var t=e.getPreviousBlock(),r=e.getNextBlock();t?t.edit():r?r.edit():n.hideEditor()}}},$.fn.lyme.plugins={ContentGuard:function(n,e){var t=!1,n="boolean"==typeof n?n:!0,e="boolean"==typeof e?e:!0;this.enable=function(){e=!0},this.disable=function(){e=!1},n&&$(document).on("submit","form",function(){e=!1}),this.onMarkupChange=function(){t=!0},$(window).bind("beforeunload",function(){return e&&t?"Are you sure you want to leave this page?":void 0})},TextareaAdapter:function(n,e){var t=$(n);this.onGetMarkup=function(){return t.val()},this.onMarkupChange=function(n,r){t.val(e?r:n)}},AjaxAdapter:function(n,e){n&&n.length&&(this.onGetMarkup=function(){var e="Failed to retrieve the from "+n;return $.ajax({url:n,type:"get",success:function(n){e=n},async:!1}),e}),e&&e.length&&(this.onMarkupChange=function(n,t){$.ajax({url:e,data:{markup:n,html:t},type:"post"})})},ScrollTo:function(n){if($.isFunction($.scrollTo)){$.isNumeric(n)||(n=200);var e;this.onPreStartEditing=function(t){window.clearTimeout(e),e=window.setTimeout(function(){$.scrollTo(t.getElement(),{duration:750,offset:{top:-100,left:0}})},n)}}}},$.fn.lyme.plugins.UndoRedo=function(n){var e;switch(n){case"localStorage":e=new $.fn.lyme.plugins.UndoRedo.LocalStorage;break;case"memory":default:e=new $.fn.lyme.plugins.UndoRedo.MemoryStorage}var t;this.setEditor=function(n){t=n},this.undo=function(){t.setMarkup(e.undo())},this.redo=function(){t.setMarkup(e.redo())},this.onPostInit=function(n){t.setMarkup(e.init(n))},this.onMarkupChange=function(n){e.push(n)}},$.fn.lyme.plugins.UndoRedo.LocalStorage=function(){function n(){localStorage.setItem(e,JSON.stringify(t))}const e="lyme";var t=new $.fn.lyme.plugins.UndoRedo.MemoryStorage,r=localStorage.getItem(e);r&&(persistedStorageObj=JSON.parse(r))&&(t.pointer=persistedStorageObj.pointer,t.entries=persistedStorageObj.entries),this.init=function(e){var r=t.getMarkup();if(r)return r;var i=t.init(e);return n(),i},this.push=function(e){t.push(e),n()},this.undo=function(){var e=t.undo();return n(),e},this.redo=function(){var e=t.redo();return n(),e}},$.fn.lyme.plugins.UndoRedo.MemoryStorage=function(){this.pointer=0,this.entries=[],this.init=function(n){return this.push(n),n},this.push=function(n){this.entries=this.entries.slice(0,this.pointer),this.entries[this.pointer++]=n},this.undo=function(){return this.pointer--,1>this.pointer&&(this.pointer=1),this.getMarkup()},this.redo=function(){return this.pointer++,this.pointer>this.entries.length&&(this.pointer=this.entries.length),this.getMarkup()},this.getMarkup=function(){return this.entries[this.pointer-1]}};