/*! lyme v1.0.0 (2013-05-09) | http://bigwhoop.github.io/lyme | MIT License */
$.fn.lyme=function(e){function n(e,n){$.isArray(n)||(n=[]),c.plugins.forEach(function(t){$.isFunction(t[e])&&t[e].apply(null,n)})}function t(e){return e=e.replace(/\r/g,""),e=e.replace(/\n\n\n/g,"\n\n"),e.split("\n\n")}function r(){return Math.floor(999999*Math.random())}function o(){var e=[];return $(".lyme-block .markup textarea").each(function(){e.push($(this).val())}),e.join("\r\n\r\n")}function i(){return c.renderer.render(o())}var a=this,u={markup:"",onMarkupChange:null,renderer:new $.fn.lyme.renderers.JSMarkdownExtra,plugins:[new $.fn.lyme.plugins.ScrollTo],hotKeys:$.fn.lyme.hotKeys},c=$.extend(u,e);if(c.markup instanceof $){var l=c.markup;c.plugins.push(new $.fn.lyme.plugins.TextareaAdapter(l))}return c.plugins.forEach(function(e){$.isFunction(e.onGetMarkup)&&(c.markup=e.onGetMarkup())}),$.isFunction(c.onMarkupChange)&&c.plugins.push({onMarkupChange:c.onMarkupChange}),a.hideEditor=function(){$(".lyme-block .markup:visible textarea").blur(),$(".lyme-block .markup:visible").hide(),$(".lyme-block .preview").show()},a.createBlock=function(e,u){function l(e){var r=p.val(),u=s;return $.each(t(r),function(e,n){var t=c.renderer.render(n);if(0==e)p.val(n),h.html(t);else{var r=a.createBlock(n,t);u.after(r.getElement()),u=r.getElement()}}),e!=r&&n("onMarkupChange",[o(),i()]),r}u||(u=c.renderer.render(e));var f=r(),s=$('<div id="lyme-block-'+f+'" class="lyme-block">'),d=$('<div class="markup"></div>'),p=$("<textarea></textarea>"),h=$('<div class="preview"></div>');p.val(e),h.html(u),d.hide().append(p),s.append(d).append(h);var k=new $.fn.lyme.Block(s);return p.on("focusout",function(){n("onPreStopEditing",[k]),""==p.val()&&s.remove(),e=l(e),n("onPostStopEditing",[k])}),p.on("keydown",function(e){for(var n in c.hotKeys){var t=c.hotKeys[n];t.if(e)&&(e.preventDefault(),t.do(a,k))}}),h.on("click",function(){a.hideEditor(),n("onPreStartEditing",[k]),h.hide(),d.show(),p.focus(),n("onPostStartEditing",[k])}),k},$(document).on("click",function(){a.hideEditor()}),this.each(function(){var e=$(this),n=t(c.markup);e.on("click",function(e){e.stopPropagation()}),$.each(n,function(n,t){var r=a.createBlock(t);e.append(r.getElement())})})},$.fn.lyme.Block=function(e){this.edit=function(){e.find(".preview").trigger("click")},this.getPreviousBlock=function(){var n=e.prev();return n.length?new $.fn.lyme.Block(n):!1},this.getNextBlock=function(){var n=e.next();return n.length?new $.fn.lyme.Block(n):!1},this.getMarkup=function(){return e.find("textarea").val()},this.setMarkup=function(n){e.find("textarea").val(n)},this.getElement=function(){return e}},$.fn.lyme.renderers={JSMarkdownExtra:function(){var e;this.render=function(n){return e||(e=new MarkdownExtra_Parser,e.init()),e.transform(n)}},Showdown:function(){var e;this.render=function(n){return e||(e=new Showdown.converter),e.makeHtml(n)}}},$.fn.lyme.hotKeys={tabbing:{indentation:"    ","if":function(e){return 9==e.keyCode},"do":function(e,n){var t=n.getElement().find("textarea").get(0),r=t.selectionStart;t.value=t.value.substring(0,t.selectionStart)+this.indentation+t.value.substring(t.selectionEnd,t.value.length),setTimeout(function(){t.focus(),t.setSelectionRange(r+4,r+4)},0)}},escape:{"if":function(e){return 27==e.keyCode},"do":function(e){e.hideEditor()}},"place-before":{"if":function(e){return e.altKey&&e.ctrlKey&&e.shiftKey&&38==e.keyCode},"do":function(e,n){var t=n.getPreviousBlock();if(t){var r=n.getMarkup(),o=t.getMarkup();n.setMarkup(o),t.setMarkup(r),t.edit()}}},"place-after":{"if":function(e){return e.altKey&&e.ctrlKey&&e.shiftKey&&40==e.keyCode},"do":function(e,n){var t=n.getNextBlock();if(t){var r=n.getMarkup(),o=t.getMarkup();n.setMarkup(o),t.setMarkup(r),t.edit()}}},"move-up":{"if":function(e){return e.altKey&&e.ctrlKey&&38==e.keyCode},"do":function(e,n){var t=n.getPreviousBlock();t&&t.edit()}},"move-down":{"if":function(e){return e.altKey&&e.ctrlKey&&40==e.keyCode},"do":function(e,n){var t=n.getNextBlock();t&&t.edit()}},"append-empty-block":{"if":function(e){return e.altKey&&e.ctrlKey&&13==e.keyCode},"do":function(e,n){var t=e.createBlock("","");n.getElement().after(t.getElement()),t.edit()}},"remove-block":{"if":function(e){return e.altKey&&e.ctrlKey&&8==e.keyCode},"do":function(e,n){n.setMarkup("");var t=n.getPreviousBlock(),r=n.getNextBlock();t?t.edit():r?r.edit():e.hideEditor()}}},$.fn.lyme.plugins={UndoRedo:function(e,n){$.isNumeric(n)||(n=50);var t;switch(e){case"localStorage":t={version:0,prefix:"rev-",push:function(e){window.localStorage.setItem(this.prefix+this.version++,e)}};break;case"memory":default:t={entries:[],push:function(e){this.entries.push(e)}}}this.onMarkupChange=function(e){t.push(e)}},ContentGuard:function(e,n){var t=!1,e="boolean"==typeof e?e:!0,n="boolean"==typeof n?n:!0;this.enable=function(){n=!0},this.disable=function(){n=!1},e&&$(document).on("submit","form",function(){n=!1}),this.onMarkupChange=function(){t=!0},$(window).bind("beforeunload",function(){return n&&t?"Are you sure you want to leave this page?":void 0})},TextareaAdapter:function(e,n){var t=$(e);this.onGetMarkup=function(){return t.val()},this.onMarkupChange=function(e,r){t.val(n?r:e)}},AjaxAdapter:function(e,n){e&&e.length&&(this.onGetMarkup=function(){var n="Failed to retrieve the from "+e;return $.ajax({url:e,type:"get",success:function(e){n=e},async:!1}),n}),n&&n.length&&(this.onMarkupChange=function(e,t){$.ajax({url:n,data:{markup:e,html:t},type:"post"})})},ScrollTo:function(e){if($.isFunction($.scrollTo)){$.isNumeric(e)||(e=200);var n;this.onPreStartEditing=function(t){window.clearTimeout(n),n=window.setTimeout(function(){$.scrollTo(t.getElement(),{duration:750,offset:{top:-100,left:0}})},e)}}}};