/*! lyme v1.2.0 (2013-05-12) | http://bigwhoop.github.io/lyme | MIT License */
$.fn.lyme=function(n){var e={markup:"",onMarkupChange:null,onPreInit:null,onPostInit:null,renderer:new $.fn.lyme.renderers.JSMarkdownExtra,plugins:[new $.fn.lyme.plugins.ScrollTo],hotKeys:$.fn.lyme.hotKeys},t=$.extend(e,n);if(t.markup instanceof $){var i=t.markup;t.plugins.push(new $.fn.lyme.plugins.TextareaAdapter(i))}t.plugins.forEach(function(n){$.isFunction(n.onGetMarkup)&&(t.markup=n.onGetMarkup())});var r={};return $.each(["onMarkupChange","onPreInit","onPostInit"],function(){$.isFunction(t[this])&&(r[this]=t[this])}),t.plugins.push(r),this.each(function(){new $.fn.lyme.Editor($(this),t)})},$.fn.lyme.Editor=function(n,e){function t(){n.on("click",function(n){n.stopPropagation()}),$(document).on("click",function(){u.hideEditor()}),e.plugins.forEach(function(n){$.isFunction(n.setEditor)&&n.setEditor(u)}),i("onPreInit",[n,e]),u.setMarkup(e.markup),i("onPostInit",[u.getFullMarkup(),u.getFullHTML()])}function i(n,t){$.isArray(t)||(t=[]),e.plugins.forEach(function(e){$.isFunction(e[n])&&e[n].apply(null,t)})}function r(n){n=n.replace(/\r/g,""),n=n.replace(/\n\n\n/g,"\n\n");for(var e=n.split("\n\n"),t=[],i=[],r=0;e.length>r;r++)0==i.length?e[r].indexOf("~~~")>-1?i.push(e[r]):t.push(e[r]):(i.push(e[r]),e[r].indexOf("~~~")>-1&&(t.push(i.join("\n\n")),i=[]));return i.length&&t.push(i.join("\n\n")),t}function o(){return a++}var u=this,a=0;u.createBlock=function(n,t){function a(n){var t=f.val(),o=l;return $.each(r(t),function(n,t){var i=e.renderer.render(t);if(0==n)f.val(t),d.html(i);else{var r=u.createBlock(t,i);o.after(r.getElement()),o=r.getElement()}}),n!=t&&i("onMarkupChange",[u.getFullMarkup(),u.getFullHTML()]),t}t||(t=e.renderer.render(n));var s=o(),l=$('<div id="lyme-block-'+s+'" class="lyme-block">'),c=$('<div class="markup"></div>'),f=$("<textarea></textarea>"),d=$('<div class="preview"></div>');f.val(n),d.html(t),c.hide().append(f),l.append(c).append(d);var p=new $.fn.lyme.Block(l);return f.on("focusout",function(){i("onPreStopEditing",[p]),""==f.val()&&l.remove(),n=a(n),i("onPostStopEditing",[p])}),f.on("keydown",function(n){for(var t in e.hotKeys){var i=e.hotKeys[t];i.if(n)&&(n.preventDefault(),i.do(u,p))}}),d.on("click",function(){u.hideEditor(),i("onPreStartEditing",[p]),d.hide(),c.show(),f.focus(),i("onPostStartEditing",[p])}),p},u.getFullMarkup=function(){var e=[];return n.find(".lyme-block .markup textarea").each(function(){e.push($(this).val())}),e.join("\r\n\r\n")},u.getFullHTML=function(){return e.renderer.render(u.getFullMarkup())},u.setMarkup=function(e){n.empty(),$.each(r(e),function(e,t){var i=u.createBlock(t);n.append(i.getElement())})},u.getElement=function(){return n},u.hideEditor=function(){n.find(".lyme-block .markup:visible textarea").blur(),n.find(".lyme-block .markup:visible").hide(),n.find(".lyme-block .preview").show()},t()},$.fn.lyme.Block=function(n){this.edit=function(){n.find(".preview").trigger("click")},this.getPreviousBlock=function(){var e=n.prev();return e.length?new $.fn.lyme.Block(e):!1},this.getNextBlock=function(){var e=n.next();return e.length?new $.fn.lyme.Block(e):!1},this.getMarkup=function(){return n.find("textarea").val()},this.setMarkup=function(e){n.find("textarea").val(e)},this.getElement=function(){return n}},$.fn.lyme.renderers={JSMarkdownExtra:function(){var n;this.render=function(e){return n||(n=new MarkdownExtra_Parser,n.init()),n.transform(e)}},Showdown:function(){var n;this.render=function(e){return n||(n=new Showdown.converter),n.makeHtml(e)}}},$.fn.lyme.hotKeys={tabbing:{indentation:"    ","if":function(n){return 9==n.keyCode},"do":function(n,e){var t=e.getElement().find("textarea").get(0),i=t.selectionStart;t.value=t.value.substring(0,t.selectionStart)+this.indentation+t.value.substring(t.selectionEnd,t.value.length),setTimeout(function(){t.focus(),t.setSelectionRange(i+4,i+4)},0)}},escape:{"if":function(n){return 27==n.keyCode},"do":function(n){n.hideEditor()}},"place-before":{"if":function(n){return n.altKey&&n.ctrlKey&&n.shiftKey&&38==n.keyCode},"do":function(n,e){var t=e.getPreviousBlock();if(t){var i=e.getMarkup(),r=t.getMarkup();e.setMarkup(r),t.setMarkup(i),t.edit()}}},"place-after":{"if":function(n){return n.altKey&&n.ctrlKey&&n.shiftKey&&40==n.keyCode},"do":function(n,e){var t=e.getNextBlock();if(t){var i=e.getMarkup(),r=t.getMarkup();e.setMarkup(r),t.setMarkup(i),t.edit()}}},"move-up":{"if":function(n){return n.altKey&&n.ctrlKey&&38==n.keyCode},"do":function(n,e){var t=e.getPreviousBlock();t&&t.edit()}},"move-down":{"if":function(n){return n.altKey&&n.ctrlKey&&40==n.keyCode},"do":function(n,e){var t=e.getNextBlock();t&&t.edit()}},"append-empty-block":{"if":function(n){return n.altKey&&n.ctrlKey&&13==n.keyCode},"do":function(n,e){var t=n.createBlock("","");e.getElement().after(t.getElement()),t.edit()}},"remove-block":{"if":function(n){return n.altKey&&n.ctrlKey&&8==n.keyCode},"do":function(n,e){e.setMarkup("");var t=e.getPreviousBlock(),i=e.getNextBlock();t?t.edit():i?i.edit():n.hideEditor()}}},$.fn.lyme.plugins={ContentGuard:function(n,e){var t=!1,n="boolean"==typeof n?n:!0,e="boolean"==typeof e?e:!0;this.enable=function(){e=!0},this.disable=function(){e=!1},n&&$(document).on("submit","form",function(){e=!1}),this.onMarkupChange=function(){t=!0},$(window).bind("beforeunload",function(){return e&&t?"Are you sure you want to leave this page?":void 0})},TextareaAdapter:function(n,e){var t=$(n);this.onGetMarkup=function(){return t.val()},this.onMarkupChange=function(n,i){t.val(e?i:n)}},AjaxAdapter:function(n,e){n&&n.length&&(this.onGetMarkup=function(){var e="Failed to retrieve the from "+n;return $.ajax({url:n,type:"get",success:function(n){e=n},async:!1}),e}),e&&e.length&&(this.onMarkupChange=function(n,t){$.ajax({url:e,data:{markup:n,html:t},type:"post"})})},ScrollTo:function(n){if($.isFunction($.scrollTo)){$.isNumeric(n)||(n=200);var e;this.onPreStartEditing=function(t){window.clearTimeout(e),e=window.setTimeout(function(){$.scrollTo(t.getElement(),{duration:750,offset:{top:-100,left:0}})},n)}}}},$.fn.lyme.plugins.UndoRedo=function(n){var e;switch(n){case"localStorage":e=new $.fn.lyme.plugins.UndoRedo.LocalStorage;break;case"memory":default:e=new $.fn.lyme.plugins.UndoRedo.MemoryStorage}var t;this.setEditor=function(n){t=n},this.undo=function(){t.setMarkup(e.undo())},this.redo=function(){t.setMarkup(e.redo())},this.onPostInit=function(n){t.setMarkup(e.init(n))},this.onMarkupChange=function(n){e.push(n)}},$.fn.lyme.plugins.UndoRedo.LocalStorage=function(){function n(){localStorage.setItem(e,JSON.stringify(t))}const e="lyme";var t=new $.fn.lyme.plugins.UndoRedo.MemoryStorage,i=localStorage.getItem(e);i&&(persistedStorageObj=JSON.parse(i))&&(t.pointer=persistedStorageObj.pointer,t.entries=persistedStorageObj.entries),this.init=function(e){var i=t.getMarkup();if(i)return i;var r=t.init(e);return n(),r},this.push=function(e){t.push(e),n()},this.undo=function(){var e=t.undo();return n(),e},this.redo=function(){var e=t.redo();return n(),e}},$.fn.lyme.plugins.UndoRedo.MemoryStorage=function(){this.pointer=0,this.entries=[],this.init=function(n){return this.push(n),n},this.push=function(n){this.entries=this.entries.slice(0,this.pointer),this.entries[this.pointer++]=n},this.undo=function(){return this.pointer--,1>this.pointer&&(this.pointer=1),this.getMarkup()},this.redo=function(){return this.pointer++,this.pointer>this.entries.length&&(this.pointer=this.entries.length),this.getMarkup()},this.getMarkup=function(){return this.entries[this.pointer-1]}};