/*! lyme v1.2.0 (2013-05-12) | http://bigwhoop.github.io/lyme | MIT License */
$.fn.lyme=function(t){var e={markup:"",onMarkupChange:null,onPreInit:null,onPostInit:null,renderer:new $.fn.lyme.renderers.JSMarkdownExtra,plugins:[new $.fn.lyme.plugins.ScrollTo],hotKeys:$.fn.lyme.hotKeys},n=$.extend(e,t);if(n.markup instanceof $){var i=n.markup;n.plugins.push(new $.fn.lyme.plugins.TextareaAdapter(i))}n.plugins.forEach(function(t){$.isFunction(t.onGetMarkup)&&(n.markup=t.onGetMarkup())});var r={};return $.each(["onMarkupChange","onPreInit","onPostInit"],function(){$.isFunction(n[this])&&(r[this]=n[this])}),n.plugins.push(r),this.each(function(){new $.fn.lyme.Editor($(this),n)})},$.fn.lyme.Editor=function(t,e){function n(){t.on("click",function(t){t.stopPropagation()}),$("document").on("click",function(){u.hideEditor()}),e.plugins.forEach(function(t){$.isFunction(t.setEditor)&&t.setEditor(u)}),i("onPreInit",[t,e]),u.setMarkup(e.markup),i("onPostInit",[u.getFullMarkup(),u.getFullHTML()])}function i(t,n){$.isArray(n)||(n=[]),e.plugins.forEach(function(e){$.isFunction(e[t])&&e[t].apply(null,n)})}function r(t){return t=t.replace(/\r/g,""),t=t.replace(/\n\n\n/g,"\n\n"),t.split("\n\n")}function o(){return a++}var u=this,a=0;u.createBlock=function(t,n){function a(t){var n=f.val(),o=l;return $.each(r(n),function(t,n){var i=e.renderer.render(n);if(0==t)f.val(n),d.html(i);else{var r=u.createBlock(n,i);o.after(r.getElement()),o=r.getElement()}}),t!=n&&i("onMarkupChange",[u.getFullMarkup(),u.getFullHTML()]),n}n||(n=e.renderer.render(t));var s=o(),l=$('<div id="lyme-block-'+s+'" class="lyme-block">'),c=$('<div class="markup"></div>'),f=$("<textarea></textarea>"),d=$('<div class="preview"></div>');f.val(t),d.html(n),c.hide().append(f),l.append(c).append(d);var p=new $.fn.lyme.Block(l);return f.on("focusout",function(){i("onPreStopEditing",[p]),""==f.val()&&l.remove(),t=a(t),i("onPostStopEditing",[p])}),f.on("keydown",function(t){for(var n in e.hotKeys){var i=e.hotKeys[n];i.if(t)&&(t.preventDefault(),i.do(u,p))}}),d.on("click",function(){u.hideEditor(),i("onPreStartEditing",[p]),d.hide(),c.show(),f.focus(),i("onPostStartEditing",[p])}),p},u.getFullMarkup=function(){var e=[];return t.find(".lyme-block .markup textarea").each(function(){e.push($(this).val())}),e.join("\r\n\r\n")},u.getFullHTML=function(){return e.renderer.render(u.getFullMarkup())},u.setMarkup=function(e){t.empty(),$.each(r(e),function(e,n){var i=u.createBlock(n);t.append(i.getElement())})},u.getElement=function(){return t},u.hideEditor=function(){t.find(".lyme-block .markup:visible textarea").blur(),t.find(".lyme-block .markup:visible").hide(),t.find(".lyme-block .preview").show()},n()},$.fn.lyme.Block=function(t){this.edit=function(){t.find(".preview").trigger("click")},this.getPreviousBlock=function(){var e=t.prev();return e.length?new $.fn.lyme.Block(e):!1},this.getNextBlock=function(){var e=t.next();return e.length?new $.fn.lyme.Block(e):!1},this.getMarkup=function(){return t.find("textarea").val()},this.setMarkup=function(e){t.find("textarea").val(e)},this.getElement=function(){return t}},$.fn.lyme.renderers={JSMarkdownExtra:function(){var t;this.render=function(e){return t||(t=new MarkdownExtra_Parser,t.init()),t.transform(e)}},Showdown:function(){var t;this.render=function(e){return t||(t=new Showdown.converter),t.makeHtml(e)}}},$.fn.lyme.hotKeys={tabbing:{indentation:"    ","if":function(t){return 9==t.keyCode},"do":function(t,e){var n=e.getElement().find("textarea").get(0),i=n.selectionStart;n.value=n.value.substring(0,n.selectionStart)+this.indentation+n.value.substring(n.selectionEnd,n.value.length),setTimeout(function(){n.focus(),n.setSelectionRange(i+4,i+4)},0)}},escape:{"if":function(t){return 27==t.keyCode},"do":function(t){t.hideEditor()}},"place-before":{"if":function(t){return t.altKey&&t.ctrlKey&&t.shiftKey&&38==t.keyCode},"do":function(t,e){var n=e.getPreviousBlock();if(n){var i=e.getMarkup(),r=n.getMarkup();e.setMarkup(r),n.setMarkup(i),n.edit()}}},"place-after":{"if":function(t){return t.altKey&&t.ctrlKey&&t.shiftKey&&40==t.keyCode},"do":function(t,e){var n=e.getNextBlock();if(n){var i=e.getMarkup(),r=n.getMarkup();e.setMarkup(r),n.setMarkup(i),n.edit()}}},"move-up":{"if":function(t){return t.altKey&&t.ctrlKey&&38==t.keyCode},"do":function(t,e){var n=e.getPreviousBlock();n&&n.edit()}},"move-down":{"if":function(t){return t.altKey&&t.ctrlKey&&40==t.keyCode},"do":function(t,e){var n=e.getNextBlock();n&&n.edit()}},"append-empty-block":{"if":function(t){return t.altKey&&t.ctrlKey&&13==t.keyCode},"do":function(t,e){var n=t.createBlock("","");e.getElement().after(n.getElement()),n.edit()}},"remove-block":{"if":function(t){return t.altKey&&t.ctrlKey&&8==t.keyCode},"do":function(t,e){e.setMarkup("");var n=e.getPreviousBlock(),i=e.getNextBlock();n?n.edit():i?i.edit():t.hideEditor()}}},$.fn.lyme.plugins={ContentGuard:function(t,e){var n=!1,t="boolean"==typeof t?t:!0,e="boolean"==typeof e?e:!0;this.enable=function(){e=!0},this.disable=function(){e=!1},t&&$(document).on("submit","form",function(){e=!1}),this.onMarkupChange=function(){n=!0},$(window).bind("beforeunload",function(){return e&&n?"Are you sure you want to leave this page?":void 0})},TextareaAdapter:function(t,e){var n=$(t);this.onGetMarkup=function(){return n.val()},this.onMarkupChange=function(t,i){n.val(e?i:t)}},AjaxAdapter:function(t,e){t&&t.length&&(this.onGetMarkup=function(){var e="Failed to retrieve the from "+t;return $.ajax({url:t,type:"get",success:function(t){e=t},async:!1}),e}),e&&e.length&&(this.onMarkupChange=function(t,n){$.ajax({url:e,data:{markup:t,html:n},type:"post"})})},ScrollTo:function(t){if($.isFunction($.scrollTo)){$.isNumeric(t)||(t=200);var e;this.onPreStartEditing=function(n){window.clearTimeout(e),e=window.setTimeout(function(){$.scrollTo(n.getElement(),{duration:750,offset:{top:-100,left:0}})},t)}}}},$.fn.lyme.plugins.UndoRedo=function(t){var e;switch(t){case"localStorage":e=new $.fn.lyme.plugins.UndoRedo.LocalStorage;break;case"memory":default:e=new $.fn.lyme.plugins.UndoRedo.MemoryStorage}var n;this.setEditor=function(t){n=t},this.undo=function(){n.setMarkup(e.undo())},this.redo=function(){n.setMarkup(e.redo())},this.onPostInit=function(t){n.setMarkup(e.init(t))},this.onMarkupChange=function(t){e.push(t)}},$.fn.lyme.plugins.UndoRedo.LocalStorage=function(){function t(){localStorage.setItem(e,JSON.stringify(n))}const e="lyme";var n=new $.fn.lyme.plugins.UndoRedo.MemoryStorage,i=localStorage.getItem(e);i&&(persistedStorageObj=JSON.parse(i))&&(n.pointer=persistedStorageObj.pointer,n.entries=persistedStorageObj.entries),this.init=function(e){var i=n.getMarkup();if(i)return i;var r=n.init(e);return t(),r},this.push=function(e){n.push(e),t()},this.undo=function(){var e=n.undo();return t(),e},this.redo=function(){var e=n.redo();return t(),e}},$.fn.lyme.plugins.UndoRedo.MemoryStorage=function(){this.pointer=0,this.entries=[],this.init=function(t){return this.push(t),t},this.push=function(t){this.entries=this.entries.slice(0,this.pointer),this.entries[this.pointer++]=t},this.undo=function(){return this.pointer--,1>this.pointer&&(this.pointer=1),this.getMarkup()},this.redo=function(){return this.pointer++,this.pointer>this.entries.length&&(this.pointer=this.entries.length),this.getMarkup()},this.getMarkup=function(){return this.entries[this.pointer-1]}};