/*! LYME v1.3.0 (2014-09-26) | http://bigwhoop.github.io/lyme | MIT License */
$.fn.lyme=function(a){var b={markup:"",onMarkupChange:null,onPreInit:null,onPostInit:null,renderer:new $.fn.lyme.renderers.JSMarkdownExtra,plugins:[new $.fn.lyme.plugins.ScrollTo,new $.fn.lyme.plugins.Blink],hotKeys:$.fn.lyme.hotKeys},c=$.extend(b,a);if(c.markup instanceof $){var d=c.markup;c.plugins.push(new $.fn.lyme.plugins.TextareaAdapter(d))}c.plugins.forEach(function(a){$.isFunction(a.onGetMarkup)&&(c.markup=a.onGetMarkup())});var e={};if($.each(["onMarkupChange","onPreInit","onPostInit"],function(){$.isFunction(c[this])&&(e[this]=c[this])}),c.plugins.push(e),1==this.length)return new $.fn.lyme.Editor($(this),c);var f={};return this.each(function(){f[this.selector]=new $.fn.lyme.Editor($(this),c)}),f},$.fn.lyme.Editor=function(a,b){function c(){a.on("click",function(a){a.stopPropagation()}),$(document).on("click",function(){f.hideEditor()}),b.plugins.forEach(function(a){$.isFunction(a.setEditor)&&a.setEditor(f)}),d("onPreInit",[a,b]),f.setMarkup(b.markup),d("onPostInit",[f.getFullMarkup(),f.getFullHTML()])}function d(a,c){$.isArray(c)||(c=[]),b.plugins.forEach(function(b){$.isFunction(b[a])&&b[a].apply(f,c)})}function e(){return g++}var f=this;f.setRenderer=function(a){b.renderer=a},f.splitMarkup=function(a){return $.isFunction(b.renderer.split)?b.renderer.split(a):a.replace(/\r/g,"").replace(/\n\n\n/g,"\n\n").split("\n\n")},f.joinMarkup=function(a){return $.isFunction(b.renderer.join)?b.renderer.join(a):a.join("\n\n")};var g=0;f.createBlock=function(a,c){function g(a){var c=k.val(),e=i;return $.each(f.splitMarkup(c),function(a,c){var d=b.renderer.render(c);if(0==a)k.val(c),l.html(d);else{var g=f.createBlock(c,d);e.after(g.getElement()),e=g.getElement()}}),a!=c&&d("onMarkupChange",[f.getFullMarkup(),f.getFullHTML()]),c}c||(c=b.renderer.render(a));var h=e(),i=$('<div id="lyme-block-'+h+'" class="lyme-block">'),j=$('<div class="markup"></div>'),k=$("<textarea></textarea>"),l=$('<div class="preview"></div>');k.val(a),l.html(c),j.hide().append(k),i.append(j).append(l);var m=new $.fn.lyme.Block(i);return k.on("focusout",function(){d("onPreStopEditing",[m]),""==k.val()&&i.remove(),a=g(a),d("onPostStopEditing",[m])}),k.on("keydown",function(a){for(var c in b.hotKeys){var d=b.hotKeys[c];d.if(a)&&(a.preventDefault(),d.do(f,m))}}),l.on("click",function(){f.hideEditor(),d("onPreStartEditing",[m]),l.hide(),j.show(),k.focus(),d("onPostStartEditing",[m])}),m},f.getFullMarkup=function(){var b=[];return a.find(".lyme-block .markup textarea").each(function(){b.push($(this).val())}),f.joinMarkup(b)},f.getFullHTML=function(){return b.renderer.render(f.getFullMarkup())},f.setMarkup=function(b){a.empty(),$.each(f.splitMarkup(b),function(b,c){var d=f.createBlock(c);a.append(d.getElement())})},f.getElement=function(){return a},f.hideEditor=function(){a.find(".lyme-block .markup:visible textarea:focus").blur(),a.find(".lyme-block .markup:visible").hide(),a.find(".lyme-block .preview").show()},c()},$.fn.lyme.Block=function(a){this.edit=function(){a.find(".preview").trigger("click")},this.getPreviousBlock=function(){var b=a.prev();return b.length?new $.fn.lyme.Block(b):!1},this.getNextBlock=function(){var b=a.next();return b.length?new $.fn.lyme.Block(b):!1},this.getMarkup=function(){return a.find("textarea").val()},this.setMarkup=function(b){a.find("textarea").val(b)},this.getElement=function(){return a}},$.fn.lyme.renderers={JSMarkdownExtra:function(){var a;this.render=function(b){return a||(a=new MarkdownExtra_Parser,a.init()),a.transform(b)},this.split=function(a){a=a.replace(/\r/g,"");var b=new RegExp("(?:~{3,}[ ]*\n[^]*?\n~{3,})+","g"),c=[];a.replace(b,function(b){var d="_LYME_PLACEHOLDER_"+c.length+"_";a=a.replace(b,d),c.push(b)});var d=a.replace(/\n\n\n/g,"\n\n").split("\n\n");for(var e in c)$.each(d,function(a,b){b=="_LYME_PLACEHOLDER_"+e+"_"&&(d[a]=c[e])});return d}},Showdown:function(){var a;this.render=function(b){return a||(a=new Showdown.converter),a.makeHtml(b)}}},$.fn.lyme.hotKeys={tabbing:{indentation:"    ","if":function(a){return 9==a.keyCode},"do":function(a,b){var c=b.getElement().find("textarea").get(0),d=c.selectionStart;c.value=c.value.substring(0,c.selectionStart)+this.indentation+c.value.substring(c.selectionEnd,c.value.length),setTimeout(function(){c.focus(),c.setSelectionRange(d+4,d+4)},0)}},escape:{"if":function(a){return 27==a.keyCode},"do":function(a){a.hideEditor()}},"place-before":{"if":function(a){return a.altKey&&a.ctrlKey&&a.shiftKey&&38==a.keyCode},"do":function(a,b){var c=b.getPreviousBlock();if(c){var d=b.getMarkup(),e=c.getMarkup();b.setMarkup(e),c.setMarkup(d),c.edit()}}},"place-after":{"if":function(a){return a.altKey&&a.ctrlKey&&a.shiftKey&&40==a.keyCode},"do":function(a,b){var c=b.getNextBlock();if(c){var d=b.getMarkup(),e=c.getMarkup();b.setMarkup(e),c.setMarkup(d),c.edit()}}},"move-up":{"if":function(a){return a.altKey&&a.ctrlKey&&38==a.keyCode},"do":function(a,b){var c=b.getPreviousBlock();c&&c.edit()}},"move-down":{"if":function(a){return a.altKey&&a.ctrlKey&&40==a.keyCode},"do":function(a,b){var c=b.getNextBlock();c&&c.edit()}},"append-empty-block":{"if":function(a){return a.altKey&&a.ctrlKey&&13==a.keyCode},"do":function(a,b){var c=a.createBlock("","");b.getElement().after(c.getElement()),c.edit()}},"remove-block":{"if":function(a){return a.altKey&&a.ctrlKey&&8==a.keyCode},"do":function(a,b){b.setMarkup("");var c=b.getPreviousBlock(),d=b.getNextBlock();c?c.edit():d?d.edit():a.hideEditor()}}},$.fn.lyme.plugins={ContentGuard:function(a,b){var c=!1,a="boolean"==typeof a?a:!0,b="boolean"==typeof b?b:!0;this.enable=function(){b=!0},this.disable=function(){b=!1},a&&$(document).on("submit","form",function(){b=!1}),this.onMarkupChange=function(){c=!0},$(window).bind("beforeunload",function(){return b&&c?"Are you sure you want to leave this page?":void 0})},TextareaAdapter:function(a,b){var c=$(a);this.onGetMarkup=function(){return c.val()},this.onMarkupChange=function(a,d){c.val(b?d:a)}},AjaxAdapter:function(a,b){a&&a.length&&(this.onGetMarkup=function(){var b="Failed to retrieve the from "+a;return $.ajax({url:a,type:"get",success:function(a){b=a},async:!1}),b}),b&&b.length&&(this.onMarkupChange=function(a,c){$.ajax({url:b,data:{markup:a,html:c},type:"post"})})},ScrollTo:function(a,b){$.isNumeric(a)||(a=300),$.isNumeric(b)||(b=50);var c;this.onPreStartEditing=function(d){window.clearTimeout(c),c=window.setTimeout(function(){$("html, body").animate({scrollTop:d.getElement().offset().top-b},750)},a)}},Blink:function(a){a||(a="#FFFBCC");var b=[];this.onPreStopEditing=function(){b=this.getElement().find(".lyme-block .preview:hidden")},this.onPostStopEditing=function(){b.each(function(){var b=$(this),c=b.css("backgroundColor");b.css({opacity:0,backgroundColor:a}),b.animate({opacity:1},200,function(){window.setTimeout(function(){b.css({backgroundColor:c})},600)})})}}},$.fn.lyme.plugins.UndoRedo=function(a){var b;switch(a){case"localStorage":b=new $.fn.lyme.plugins.UndoRedo.LocalStorage;break;case"memory":default:b=new $.fn.lyme.plugins.UndoRedo.MemoryStorage}var c;this.setEditor=function(a){c=a},this.undo=function(){c.setMarkup(b.undo())},this.redo=function(){c.setMarkup(b.redo())},this.onPostInit=function(a){c.setMarkup(b.init(a))},this.onMarkupChange=function(a){b.push(a)}},$.fn.lyme.plugins.UndoRedo.LocalStorage=function(){function a(){localStorage.setItem(b,JSON.stringify(c))}const b="lyme";var c=new $.fn.lyme.plugins.UndoRedo.MemoryStorage,d=localStorage.getItem(b);d&&(persistedStorageObj=JSON.parse(d))&&(c.pointer=persistedStorageObj.pointer,c.entries=persistedStorageObj.entries),this.init=function(b){var d=c.getMarkup();if(d)return d;var e=c.init(b);return a(),e},this.push=function(b){c.push(b),a()},this.undo=function(){var b=c.undo();return a(),b},this.redo=function(){var b=c.redo();return a(),b}},$.fn.lyme.plugins.UndoRedo.MemoryStorage=function(){this.pointer=0,this.entries=[],this.init=function(a){return this.push(a),a},this.push=function(a){this.entries=this.entries.slice(0,this.pointer),this.entries[this.pointer++]=a},this.undo=function(){return this.pointer--,this.pointer<1&&(this.pointer=1),this.getMarkup()},this.redo=function(){return this.pointer++,this.pointer>this.entries.length&&(this.pointer=this.entries.length),this.getMarkup()},this.getMarkup=function(){return this.entries[this.pointer-1]}};