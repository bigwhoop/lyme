$.fn.lyme=function(e){function j(b,g){$.isArray(g)||(g=[]);var d,c=function(c){$.isFunction(c[b])&&(d=c[b].apply(null,g))};h.basePlugins.forEach(c);h.plugins.forEach(c);return d}function m(b){b=b.replace(/\r/g,"");b=b.replace(/\n\n\n/g,"\n\n");return b.split("\n\n")}function k(){$(".lyme-block .code:visible textarea").blur();$(".lyme-block .code:visible").hide();$(".lyme-block .preview").show()}function d(b){b.find(".preview").trigger("click")}function n(b){function g(){var a=f.val(),a=m(a),b=c;$.each(a,
function(a,c){var d=j("onTextToHtmlConversion",[c]);0==a?(f.val(c),l.html(d)):(d=n(c),b.after(d),b=d)});j("onTextChange",[p()])}var h=Math.floor(999999*Math.random()),c=$('<div id="lyme-block-'+h+'" class="lyme-block">'),e=$('<div class="code">'),f=$("<textarea>"+b+"</textarea>"),l=$('<div class="preview">');e.hide().append(f);c.append(e).append(l);f.on("keydown",function(a){if(9==a.keyCode){a.preventDefault();var b=this,e=b.selectionStart;b.value=b.value.substring(0,b.selectionStart)+"    "+b.value.substring(b.selectionEnd,
b.value.length);setTimeout(function(){b.focus();b.setSelectionRange(e+4,e+4)},0)}else if(27==a.keyCode)k();else if(a.altKey&&a.ctrlKey&&a.shiftKey&&38==a.keyCode){if($prev=c.prev(),$prev.length){a=f.val();var g=$prev.find(".code textarea").val();f.val(g);$prev.find(".code textarea").val(a);d($prev)}}else a.altKey&&a.ctrlKey&&a.shiftKey&&40==a.keyCode?($next=c.next(),$next.length&&(a=f.val(),g=$next.find(".code textarea").val(),f.val(g),$next.find(".code textarea").val(a),d($next))):a.altKey&&a.ctrlKey&&
38==a.keyCode?($prev=c.prev(),$prev.length&&d($prev)):a.altKey&&a.ctrlKey&&40==a.keyCode?($next=c.next(),$next.length&&d($next)):a.altKey&&a.ctrlKey&&13==a.keyCode?(a=m(""),a=n(a[0]),c.after(a),d(a)):a.altKey&&(a.ctrlKey&&8==a.keyCode)&&(f.val(""),$prev=c.prev(),$next=c.next(),$prev.length?d($prev):$next.length?d($next):k())});l.on("click",function(){k();j("onPreStartEditing",[c]);l.hide();e.show();f.focus();j("onPostStartEditing",[c])});g();f.on("focusout",function(){""==f.val()&&c.remove();g()});
return c}function p(){var b=[];$(".lyme-block .code textarea").each(function(){b.push($(this).val())});return b.join("\r\n\r\n")}var h=$.extend({text:"",onTextChange:null,plugins:[],basePlugins:[$.fn.lyme.plugins.showdown,$.fn.lyme.plugins.scrollTo]},e);$.isFunction(h.onTextChange)&&h.plugins.push({onTextChange:h.onTextChange});$(document).on("click",function(){k()});return this.each(function(){var b=$(this),d=m(h.text);b.on("click",function(b){b.stopPropagation()});$.each(d,function(d,c){var e=n(c);
b.append(e)});j("onTextChange",[p()])})};$.fn.lyme.plugins={showdown:{converter:null,onTextToHtmlConversion:function(e){this.converter||(this.converter=new Showdown.converter);return this.converter.makeHtml(e)}},scrollTo:{scrollTimeout:null,onPreStartEditing:function(e){window.clearTimeout(this.scrollTimeout);this.scrollTimeout=window.setTimeout(function(){$.scrollTo(e,{duration:750,offset:{top:-100,left:0}})},200)}}};
